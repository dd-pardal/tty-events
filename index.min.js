const EventEmitter=require("events");class KeyboardEvent{constructor({name:e,sequence:t,isSpecial:a=false,ctrl:i=false,alt:s=false,shift:n=false}){if(typeof e!=="string")throw new TypeError;this.name=e;this.sequence=t;this.isSpecial=a;this.ctrl=i;this.alt=s;this.shift=n}toString(){return(this.ctrl?"Ctrl+":"")+(this.alt?"Alt+":"")+(this.shift?"Shift+":"")+this.name}}class MouseEvent{constructor(e){Object.assign(this,e)}}function*emitKeys(e){function t(t,a,i,s=false){if(t<0||a<1||i<1||isNaN(t)||isNaN(a)||isNaN(i))return;let n,r,c={x:a,y:i};n=t&3;if(t&64||t&128){if(t&64)n|=4;if(t&128)n|=8}else if(n===3)n=undefined;else n+=1;c.button=n;if(t&32){r="mousemove"}else{switch(n){case undefined:r="mouseup";break;case 4:r="wheel";c.direction=-1;break;case 5:r="wheel";c.direction=1;break;default:if(s)r="mouseup";else r="mousedown";break}}c.shift=Boolean(t&4);c.alt=Boolean(t&8);c.ctrl=Boolean(t&16);c.type=r;e.emit(r,new MouseEvent(c));e.emit("mouse",new MouseEvent(c))}let a=false,i=yield,s;e:while(true){if(i===""){i=yield;continue}s=i;const n={name:undefined,sequence:undefined,isSpecial:true,ctrl:false,alt:false,shift:false};let r=0;if(i===""){r=1;s+=i=yield;if(i===""){r=2;s+=i=yield}if(i===""||s.length>1&&i===""){e.emit("keypress",new KeyboardEvent({name:"escape",sequence:s,isSpecial:true}));i=yield;if(i===""){i=yield}continue}}if(r&&(i==="O"||i==="[")){let a=i;let c=0;if(i==="O"){s+=i=yield;if(i>="0"&&i<="9"){c=(i>>0)-1;s+=i=yield}else if(i===""){e.emit("keypress",new KeyboardEvent({name:"O",sequence:s,alt:true}));i=yield;continue e}a+=i}else if(i==="["){const l=s.length;s+=i=yield;if(i===""){e.emit("keypress",new KeyboardEvent({name:"[",sequence:s,alt:true}));i=yield;continue e}if(i==="M"){for(let t=0;t<3;t++){i=yield;if(i===""){e.emit("unknownSequence",s);i=yield;continue e}s+=i}t(s[l+1].charCodeAt(0)-32,s[l+2].charCodeAt(0)-32,s[l+3].charCodeAt(0)-32);i=yield;continue}if(i==="["){a+=i;s+=i=yield}const o=s.length-1;while(true){const t=i.charCodeAt(0);if(t>=64&&t<=126||t===36){break}else if(t>=32&&t<=63){s+=i=yield}else{e.emit("unknownSequence",s);continue e}}const f=s.slice(l);if(f[0]==="<"&&(i==="M"||i==="m")||f[0]==="I"||f[0]==="O"||f==="200~"){if(r>=2){e.emit("keypress",new Key({name:"escape",isSpecial:true}))}if(f[0]==="<"&&(i==="M"||i==="m")){const e=s.slice(3,s.length-1).split(";");if(e.length===3){t(parseInt(e[0]),parseInt(e[1]),parseInt(e[2]),i==="m")}}else if(f[0]==="I"){e.emit("focusin")}else if(f[0]==="O"){e.emit("focusout")}else if(f==="200~"){const t="[201~";let a="",s=0;while(true){a+=i=yield;if(i===t[s])s++;else s=0;if(s>=t.length){e.emit("paste",Buffer.from(a.slice(0,a.length-t.length),"binary").toString("utf-8"));break}}}i=yield;continue}const u=s.slice(o);let m;if(m=u.match(/^(\d\d?)(;(\d))?([~^$])$/)){a+=m[1]+m[4];c=(m[3]||1)-1}else if(m=u.match(/^((\d;)?(\d))?([A-Za-z])$/)){a+=m[4];c=(m[3]||1)-1}else{a+=u}switch(a[a.length-1]){case"$":n.shift=true;a=a.slice(0,a.length-1)+"~";break;case"^":n.ctrl=true;a=a.slice(0,a.length-1)+"~";break;case"@":n.shift=n.ctrl=true;a=a.slice(0,a.length-1)+"~";break}}n.ctrl=n.ctrl||Boolean(c&4);n.alt=Boolean(c&10);n.shift=n.shift||Boolean(c&1);if(r>=2){n.alt=true}if(a.match(/^(O|\[)[A-Z]$/)){switch(a[1]){case"A":n.name="up";break;case"B":n.name="down";break;case"C":n.name="right";break;case"D":n.name="left";break;case"E":n.name="clear";break;case"F":n.name="end";break;case"H":n.name="home";break;case"P":n.name="f1";break;case"Q":n.name="f2";break;case"R":n.name="f3";break;case"S":n.name="f4";break}}else{switch(a){case"[11~":n.name="f1";break;case"[12~":n.name="f2";break;case"[13~":n.name="f3";break;case"[14~":n.name="f4";break;case"[[A":n.name="f1";break;case"[[B":n.name="f2";break;case"[[C":n.name="f3";break;case"[[D":n.name="f4";break;case"[[E":n.name="f5";break;case"[15~":n.name="f5";break;case"[17~":n.name="f6";break;case"[18~":n.name="f7";break;case"[19~":n.name="f8";break;case"[20~":n.name="f9";break;case"[21~":n.name="f10";break;case"[23~":n.name="f11";break;case"[24~":n.name="f12";break;case"[25~":n.name="f3";n.shift=true;break;case"[26~":n.name="f4";n.shift=true;break;case"[28~":n.name="f5";n.shift=true;break;case"[29~":n.name="f6";n.shift=true;break;case"[31~":n.name="f7";n.shift=true;break;case"[32~":n.name="f8";n.shift=true;break;case"[33~":n.name="f9";n.shift=true;break;case"[34~":n.name="f10";n.shift=true;break;case"[1~":n.name="home";break;case"[2~":n.name="insert";break;case"[3~":n.name="delete";break;case"[4~":n.name="end";break;case"[5~":n.name="pageup";break;case"[6~":n.name="pagedown";break;case"[[5~":n.name="pageup";break;case"[[6~":n.name="pagedown";break;case"[7~":n.name="home";break;case"[8~":n.name="end";break;case"[a":n.name="up";n.shift=true;break;case"[b":n.name="down";n.shift=true;break;case"[c":n.name="right";n.shift=true;break;case"[d":n.name="left";n.shift=true;break;case"[e":n.name="clear";n.shift=true;break;case"Oa":n.name="up";n.ctrl=true;break;case"Ob":n.name="down";n.ctrl=true;break;case"Oc":n.name="right";n.ctrl=true;break;case"Od":n.name="left";n.ctrl=true;break;case"Oe":n.name="clear";n.ctrl=true;break;case"[Z":n.name="tab";n.shift=true;break}}n.sequence=s;if(n.name!==undefined){e.emit("keypress",new KeyboardEvent(n))}else{e.emit("unknownSequence",s)}i=yield;continue}else{n.alt=Boolean(r);n.sequence=s;if(i==="\r"){n.name="enter"}else if(i==="\n"){if(a){i=yield;continue}n.name="enter"}else if(i==="\t"){n.name="tab"}else if(i==="\b"||i===""){n.name="backspace"}else if(i===" "){n.name="space"}else if(i<=""){n.name=String.fromCharCode(i.charCodeAt(0)+64).toLowerCase();n.ctrl=true}else if(i===""){n.name="-";n.ctrl=true}else{n.isSpecial=false;const e=i.charCodeAt(0);if(!(e&128)){n.name=i}else if(e&64){let t;if(e&32){if(e&16){if(e&8){continue}else{t=4}}else{t=3}}else{t=2}let a,s,r,c;switch(t){case 2:a=(i=yield).charCodeAt(0);if(!(a&128)||a&64){continue}n.name=String.fromCharCode((e&31)<<6|a&63);break;case 3:a=(i=yield).charCodeAt(0);if(!(a&128)||a&64){continue}s=(i=yield).charCodeAt(0);if(!(s&128)||s&64){continue}c=(e&15)<<12|(a&63)<<6|s&63;if(c>=55296&&c<=57343){continue}n.name=String.fromCharCode(c);break;case 4:a=(i=yield).charCodeAt(0);if(!(a&128)||a&64){e=a;continue}s=(i=yield).charCodeAt(0);if(!(s&128)||s&64){e=s;continue}r=(i=yield).charCodeAt(0);if(!(r&128)||r&64){e=r;continue}c=(e&7)<<18|(a&63)<<12|(s&63)<<6|r&63;if(c>=55296&&c<=57343){continue}n.name=String.fromCodePoint(c);break}}n.sequence="".repeat(r)+n.name}}e.emit("keypress",new KeyboardEvent(n));a=i==="\r";i=yield}}class Terminal extends EventEmitter{constructor(e=process.stdin,t,{escKeyTimeout:a=500,timeout:i=a}={}){super();const s=emitKeys(this);s.next();this._dataListener=e=>{e=e.toString("binary");for(let t=0;t<e.length;t++){s.next(e[t])}if(this._timeoutID){clearTimeout(this._timeoutID)}if(this.timeout!==Infinity){this._timeoutID=setTimeout(()=>{this._timeoutID=undefined;s.next("")},this.timeout)}};this._input=e;this.output=t||(e===process.stdin?process.stdout:null);this.timeout=i;this._timeoutID=undefined;this.resume()}pause(){this._input.removeListener("data",this._dataListener)}resume(){this._input.on("data",this._dataListener)}enableMouse(e=0,t=true){this.output.write(`[?1000h`);if(e>=2)this.output.write(`[?1002h`);if(e==3)this.output.write(`[?1003h`);if(t)this.output.write(`[?1006h`)}disableMouse(){this.output.write(`[?1000l`)}enableBPM(){this.output.write("[?2004h")}disableBPM(){this.output.write("[?2004l")}enableFocus(){this.output.write("[?1004h")}disableFocus(){this.output.write("[?1004l")}}Object.assign(Terminal,{VT200_MOUSE:0,BTN_EVENT_MOUSE:2,ANY_EVENT_MOUSE:3,KeyboardEvent:KeyboardEvent,MouseEvent:MouseEvent});module.exports=Terminal;