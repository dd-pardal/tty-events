const e=require("events"),{StringDecoder:t}=require("string_decoder");class a{constructor({name:e,sequence:t,isSpecial:a=false,ctrl:s=false,alt:i=false,shift:n=false}){if(typeof e!=="string")throw new TypeError;this.name=e;this.sequence=t;this.isSpecial=a;this.ctrl=s;this.alt=i;this.shift=n}get meta(){return this.alt}set meta(e){this.alt=e}toString(){return(this.ctrl?"Ctrl+":"")+(this.alt?"Alt+":"")+(this.shift?"Shift+":"")+this.name}}class s{constructor(e){Object.assign(this,e)}}class i{constructor(e,t,a,s,i,n){this.startX=e;this.startY=t;this.endX=a;this.endY=s;this.mouseX=i;this.mouseY=n}}function*n(e){function t(t,a,i,n=false){if(t<0||a<1||i<1||isNaN(t)||isNaN(a)||isNaN(i))return;let r,l,c={x:a,y:i};r=t&3;if(t&64||t&128){if(t&64)r|=4;if(t&128)r|=8}else if(r===3)r=undefined;else r+=1;c.button=r;if(t&32){l="mousemove"}else if(r===undefined||n){l="mouseup"}else if(r===4){l="wheel";c.direction=-1}else if(r===5){l="wheel";c.direction=1}else{l="mousedown"}c.shift=Boolean(t&4);c.alt=Boolean(t&8);c.ctrl=Boolean(t&16);c.type=l;e.emit(l,new s(c));e.emit("mouse",new s(c))}function n(t){var a,s,n,r,l,c;if(t.length===6)[a,s,n,r,l,c]=t;else{n=l=t[0];r=c=t[1]}e.emit("highlight",new i(a,s,n,r,l,c))}function r(){e.emit("keypress",new a({name:"escape",sequence:"",isSpecial:true}))}var l=false,c=yield,u;e:while(true){if(c===""){c=yield;continue}u=c;const s={name:undefined,sequence:undefined,isSpecial:true,ctrl:false,alt:false,shift:false};let i=0;if(c===""){i=1;u+=c=yield;if(c===""){i=2;u+=c=yield}if(c===""||u.length>1&&c===""){e.emit("keypress",new a({name:"escape",sequence:u,isSpecial:true}));c=yield;if(c===""){c=yield}continue}}if(i&&(c==="O"||c==="[")){let l=c;let f=0;if(c==="O"){u+=c=yield;if(c>="0"&&c<="9"){f=(c>>0)-1;u+=c=yield}else if(c===""){e.emit("keypress",new a({name:"O",sequence:u,alt:true}));c=yield;continue e}l+=c}else if(c==="["){const o=u.length;u+=c=yield;if(c===""){e.emit("keypress",new a({name:"[",sequence:u,alt:true}));c=yield;continue e}if(c==="M"){const a=[];for(let t=0;t<3;t++){let t=yield true;if(t===""){e.emit("unknownSequence",u);c=yield;continue e}a.push(t-32)}t(...a);c=yield;continue}else if(c==="T"||c==="t"){const t=c,a=t==="T"?6:2;const s=[];for(let t=0;t<a;t++){let t=yield true;if(t===""){e.emit("unknownSequence",u);c=yield;continue e}s.push(t-32)}n(s);c=yield;continue}if(c==="["){l+=c;u+=c=yield}const m=u.length-1;while(true){const t=c.charCodeAt(0);if(t>=64&&t<=126||t===36){break}else if(t>=32&&t<=63){u+=c=yield}else{e.emit("unknownSequence",u);continue e}}const h=u.slice(o);if(h[0]==="<"&&(c==="M"||c==="m")||h[0]==="<"&&(c==="T"||c==="t")||c==="I"||c==="O"||h==="200~"){if(i>=2)r();if(c==="M"||c==="m"||c==="T"||c==="t"){const a=c==="M"||c==="m",s=h.slice(1,h.length-1).split(";");let i=s.length!==(a?3:c==="t"?2:6);if(!i){for(let e=0;e<s.length;e++){const t=parseInt(s[e]);if(isNaN(t)){i=true;break}s[e]=t}}if(i){e.emit("unknownSequence",u)}else{if(a){t(...s,c==="m")}else{n(s)}}}else if(c==="I"){e.emit("focusin")}else if(c==="O"){e.emit("focusout")}else if(h==="200~"){const t="[201~";let a="",s=0;while(true){a+=c=yield;if(c===t[s])s++;else s=0;if(s>=t.length){e.emit("paste",a.slice(0,a.length-t.length));break}}}c=yield;continue}const d=u.slice(m);let b;if(b=d.match(/^(\d\d?)(;(\d))?([~^$])$/)){l+=b[1]+b[4];f=(b[3]||1)-1}else if(b=d.match(/^((\d;)?(\d))?([A-Za-z])$/)){l+=b[4];f=(b[3]||1)-1}else{l+=d}switch(l[l.length-1]){case"$":s.shift=true;l=l.slice(0,l.length-1)+"~";break;case"^":s.ctrl=true;l=l.slice(0,l.length-1)+"~";break;case"@":s.shift=s.ctrl=true;l=l.slice(0,l.length-1)+"~";break}}s.ctrl=s.ctrl||Boolean(f&4);s.alt=Boolean(f&10);s.shift=s.shift||Boolean(f&1);if(i>=2){s.alt=true}if(l.match(/^(O|\[)[A-Z]$/)){switch(l[1]){case"A":s.name="up";break;case"B":s.name="down";break;case"C":s.name="right";break;case"D":s.name="left";break;case"E":s.name="clear";break;case"F":s.name="end";break;case"H":s.name="home";break;case"P":s.name="f1";break;case"Q":s.name="f2";break;case"R":s.name="f3";break;case"S":s.name="f4";break}}else{switch(l){case"[11~":s.name="f1";break;case"[12~":s.name="f2";break;case"[13~":s.name="f3";break;case"[14~":s.name="f4";break;case"[[A":s.name="f1";break;case"[[B":s.name="f2";break;case"[[C":s.name="f3";break;case"[[D":s.name="f4";break;case"[[E":s.name="f5";break;case"[15~":s.name="f5";break;case"[17~":s.name="f6";break;case"[18~":s.name="f7";break;case"[19~":s.name="f8";break;case"[20~":s.name="f9";break;case"[21~":s.name="f10";break;case"[23~":s.name="f11";break;case"[24~":s.name="f12";break;case"[25~":s.name="f3";s.shift=true;break;case"[26~":s.name="f4";s.shift=true;break;case"[28~":s.name="f5";s.shift=true;break;case"[29~":s.name="f6";s.shift=true;break;case"[31~":s.name="f7";s.shift=true;break;case"[32~":s.name="f8";s.shift=true;break;case"[33~":s.name="f9";s.shift=true;break;case"[34~":s.name="f10";s.shift=true;break;case"[1~":s.name="home";break;case"[2~":s.name="insert";break;case"[3~":s.name="delete";break;case"[4~":s.name="end";break;case"[5~":s.name="pageup";break;case"[6~":s.name="pagedown";break;case"[[5~":s.name="pageup";break;case"[[6~":s.name="pagedown";break;case"[7~":s.name="home";break;case"[8~":s.name="end";break;case"[a":s.name="up";s.shift=true;break;case"[b":s.name="down";s.shift=true;break;case"[c":s.name="right";s.shift=true;break;case"[d":s.name="left";s.shift=true;break;case"[e":s.name="clear";s.shift=true;break;case"Oa":s.name="up";s.ctrl=true;break;case"Ob":s.name="down";s.ctrl=true;break;case"Oc":s.name="right";s.ctrl=true;break;case"Od":s.name="left";s.ctrl=true;break;case"Oe":s.name="clear";s.ctrl=true;break;case"[Z":s.name="tab";s.shift=true;break}}s.sequence=u;if(s.name!==undefined){e.emit("keypress",new a(s))}else{e.emit("unknownSequence",u)}c=yield;continue}else{if(i>=2)r();s.alt=Boolean(i);s.sequence=u;if(c==="\r"){s.name="enter"}else if(c==="\n"){if(l){c=yield;continue}s.name="enter"}else if(c==="\t"){s.name="tab"}else if(c==="\b"||c===""){s.name="backspace"}else if(c===" "){s.name="space"}else if(c<=""){s.name=String.fromCharCode(c.charCodeAt(0)+64).toLowerCase();s.ctrl=true}else if(c===""){s.name="-";s.ctrl=true}else{s.isSpecial=false;s.name=c;s.sequence=(i?"":"")+s.name}}e.emit("keypress",new a(s));l=c==="\r";c=yield}}class r extends e{constructor(e=process.stdin,a,{escKeyTimeout:s=500,timeout:i=s,encoding:r}={}){super();const l=new t(r),c=n(this);var u=c.next().value;this._dataListener=e=>{for(let t=0;t<e.length;t++){if(u)u=c.next(e[t]).value;else{let a=l.write(Buffer.from([e[t]]));if(a)for(let e of a){if(c.next(e).value){u=true;break}}}}if(this._timeoutID){clearTimeout(this._timeoutID)}if(this.timeout!==Infinity){this._timeoutID=setTimeout(()=>{this._timeoutID=undefined;u=c.next("").value},this.timeout)}};this._input=e;this.output=a||(e===process.stdin?process.stdout:null);this._encoding=r;this.timeout=i;this._timeoutID=undefined;this.resume();e.on("end",()=>{if(!u){let e=l.end();if(e)for(let t of e){if(c.next(t).value){u=true;break}}}})}pause(){this._input.removeListener("data",this._dataListener)}resume(){this._input.on("data",this._dataListener)}enableMouse(e=0,t=true){this.output.write(`[?1000h`);if(e===1)this.output.write(`[?1001h`);else{if(e>=2)this.output.write(`[?1002h`);if(e===3)this.output.write(`[?1003h`)}if(t)this.output.write(`[?1006h`)}disableMouse(){this.output.write(`[?1000l[?1006l`)}enableBPM(){this.output.write("[?2004h")}disableBPM(){this.output.write("[?2004l")}enableFocus(){this.output.write("[?1004h")}disableFocus(){this.output.write("[?1004l")}}Object.assign(r,{VT200_MOUSE:0,VT200_HIGHLIGHT_MOUSE:1,BTN_EVENT_MOUSE:2,ANY_EVENT_MOUSE:3,KeyboardEvent:a,MouseEvent:s,HighlightEvent:i});module.exports=r;