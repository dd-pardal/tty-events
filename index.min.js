const e=require("events"),{StringDecoder:t}=require("string_decoder");class s{constructor({name:e,sequence:t,isSpecial:s=false,ctrl:i=false,alt:a=false,shift:n=false}){if(typeof e!=="string")throw new TypeError;this.name=e;this.sequence=t;this.isSpecial=s;this.ctrl=i;this.alt=a;this.shift=n}get meta(){return this.alt}set meta(e){this.alt=e}toString(){return(this.ctrl?"Ctrl+":"")+(this.alt?"Alt+":"")+(this.shift?"Shift+":"")+this.name}}class i{constructor(e){Object.assign(this,e)}}class a{constructor(e,t,s,i,a,n){this.startX=e;this.startY=t;this.endX=s;this.endY=i;this.mouseX=a;this.mouseY=n}}function*n(e){function t(t,s,a,n=false){if(t<0||s<1||a<1||isNaN(t)||isNaN(s)||isNaN(a))return;let r,l,u={x:s,y:a};r=t&3;if(t&64||t&128){if(t&64)r|=4;if(t&128)r|=8}else if(r===3)r=undefined;else r+=1;u.button=r;if(t&32){l="mousemove"}else if(r===undefined||n){l="mouseup"}else if(r===4){l="wheel";u.direction=-1}else if(r===5){l="wheel";u.direction=1}else{l="mousedown"}u.shift=Boolean(t&4);u.alt=Boolean(t&8);u.ctrl=Boolean(t&16);u.type=l;e.emit(l,new i(u));e.emit("mouse",new i(u))}function n(t){var s,i,n,r,l,u;if(t.length===6)[s,i,n,r,l,u]=t;else{n=l=t[0];r=u=t[1]}e.emit("highlight",new a(s,i,n,r,l,u))}function r(){e.emit("keypress",new s({name:"escape",sequence:"",isSpecial:true}))}var l=false,u=yield,c;e:while(true){if(u===""){u=yield;continue}c=u;const i={name:undefined,sequence:undefined,isSpecial:true,ctrl:false,alt:false,shift:false};let a=0;if(u===""){a=1;c+=u=yield;if(u===""){a=2;c+=u=yield}if(u===""||c.length>1&&u===""){e.emit("keypress",new s({name:"escape",sequence:c,isSpecial:true}));u=yield;if(u===""){u=yield}continue}}if(a&&(u==="O"||u==="[")){let l=u;let f=0;if(u==="O"){c+=u=yield;if(u>="0"&&u<="9"){f=(u>>0)-1;c+=u=yield}else if(u===""){e.emit("keypress",new s({name:"O",sequence:c,alt:true}));u=yield;continue e}l+=u}else if(u==="["){const o=c.length;c+=u=yield;if(u===""){e.emit("keypress",new s({name:"[",sequence:c,alt:true}));u=yield;continue e}if(u==="M"){const s=[];for(let t=0;t<3;t++){let t=yield true;if(t===""){e.emit("unknownSequence",c);u=yield;continue e}s.push(t-32)}t(...s);u=yield;continue}else if(u==="T"||u==="t"){const t=u,s=t==="T"?6:2;const i=[];for(let t=0;t<s;t++){let t=yield true;if(t===""){e.emit("unknownSequence",c);u=yield;continue e}i.push(t-32)}n(i);u=yield;continue}if(u==="["){l+=u;c+=u=yield}const h=c.length-1;while(true){const t=u.charCodeAt(0);if(t>=64&&t<=126||t===36){break}else if(t>=32&&t<=63){c+=u=yield}else{e.emit("unknownSequence",c);continue e}}const m=c.slice(o);if(m[0]==="<"&&(u==="M"||u==="m")||m[0]==="<"&&(u==="T"||u==="t")||u==="I"||u==="O"||m==="200~"){if(a>=2)r();if(u==="M"||u==="m"||u==="T"||u==="t"){const s=u==="M"||u==="m",i=m.slice(1,m.length-1).split(";");let a=i.length!==(s?3:u==="t"?2:6);if(!a){for(let e=0;e<i.length;e++){const t=parseInt(i[e]);if(isNaN(t)){a=true;break}i[e]=t}}if(a){e.emit("unknownSequence",c)}else{if(s){t(...i,u==="m")}else{n(i)}}}else if(u==="I"){e.emit("focusin")}else if(u==="O"){e.emit("focusout")}else if(m==="200~"){const t="[201~";let s="",i=0;while(true){s+=u=yield;if(u===t[i])i++;else i=0;if(i>=t.length){e.emit("paste",s.slice(0,s.length-t.length));break}}}u=yield;continue}const d=c.slice(h);let b;if(b=d.match(/^(\d\d?)(;(\d))?([~^$])$/)){l+=b[1]+b[4];f=(b[3]||1)-1}else if(b=d.match(/^((\d;)?(\d))?([A-Za-z])$/)){l+=b[4];f=(b[3]||1)-1}else{l+=d}switch(l[l.length-1]){case"$":i.shift=true;l=l.slice(0,l.length-1)+"~";break;case"^":i.ctrl=true;l=l.slice(0,l.length-1)+"~";break;case"@":i.shift=i.ctrl=true;l=l.slice(0,l.length-1)+"~";break}}i.ctrl=i.ctrl||Boolean(f&4);i.alt=Boolean(f&10);i.shift=i.shift||Boolean(f&1);if(a>=2){i.alt=true}if(l.match(/^(O|\[)[A-Z]$/)){switch(l[1]){case"A":i.name="up";break;case"B":i.name="down";break;case"C":i.name="right";break;case"D":i.name="left";break;case"E":i.name="clear";break;case"F":i.name="end";break;case"H":i.name="home";break;case"P":i.name="f1";break;case"Q":i.name="f2";break;case"R":i.name="f3";break;case"S":i.name="f4";break}}else{switch(l){case"[11~":i.name="f1";break;case"[12~":i.name="f2";break;case"[13~":i.name="f3";break;case"[14~":i.name="f4";break;case"[[A":i.name="f1";break;case"[[B":i.name="f2";break;case"[[C":i.name="f3";break;case"[[D":i.name="f4";break;case"[[E":i.name="f5";break;case"[15~":i.name="f5";break;case"[17~":i.name="f6";break;case"[18~":i.name="f7";break;case"[19~":i.name="f8";break;case"[20~":i.name="f9";break;case"[21~":i.name="f10";break;case"[23~":i.name="f11";break;case"[24~":i.name="f12";break;case"[25~":i.name="f3";i.shift=true;break;case"[26~":i.name="f4";i.shift=true;break;case"[28~":i.name="f5";i.shift=true;break;case"[29~":i.name="f6";i.shift=true;break;case"[31~":i.name="f7";i.shift=true;break;case"[32~":i.name="f8";i.shift=true;break;case"[33~":i.name="f9";i.shift=true;break;case"[34~":i.name="f10";i.shift=true;break;case"[1~":i.name="home";break;case"[2~":i.name="insert";break;case"[3~":i.name="delete";break;case"[4~":i.name="end";break;case"[5~":i.name="pageup";break;case"[6~":i.name="pagedown";break;case"[[5~":i.name="pageup";break;case"[[6~":i.name="pagedown";break;case"[7~":i.name="home";break;case"[8~":i.name="end";break;case"[a":i.name="up";i.shift=true;break;case"[b":i.name="down";i.shift=true;break;case"[c":i.name="right";i.shift=true;break;case"[d":i.name="left";i.shift=true;break;case"[e":i.name="clear";i.shift=true;break;case"Oa":i.name="up";i.ctrl=true;break;case"Ob":i.name="down";i.ctrl=true;break;case"Oc":i.name="right";i.ctrl=true;break;case"Od":i.name="left";i.ctrl=true;break;case"Oe":i.name="clear";i.ctrl=true;break;case"[Z":i.name="tab";i.shift=true;break}}i.sequence=c;if(i.name!==undefined){e.emit("keypress",new s(i))}else{e.emit("unknownSequence",c)}u=yield;continue}else{if(a>=2)r();i.alt=Boolean(a);i.sequence=c;if(u==="\r"){i.name="enter"}else if(u==="\n"){if(l){u=yield;continue}i.name="enter"}else if(u==="\t"){i.name="tab"}else if(u==="\b"||u===""){i.name="backspace"}else if(u===" "){i.name="space"}else if(u<=""){i.name=String.fromCharCode(u.charCodeAt(0)+64).toLowerCase();i.ctrl=true}else if(u===""){i.name="-";i.ctrl=true}else{i.isSpecial=false;i.name=u;i.sequence=(a?"":"")+i.name}}e.emit("keypress",new s(i));l=u==="\r";u=yield}}class r extends e{constructor(e=process.stdin,s,{escKeyTimeout:i=500,timeout:a=i,encoding:r}={}){super();const l=new t(r),u=n(this);var c=u.next().value;this._dataListener=e=>{for(let t=0;t<e.length;t++){if(c)c=u.next(e[t]).value;else{let s=l.write(Buffer.from([e[t]]));if(s)for(let e of s){if(u.next(e).value){c=true;break}}}}if(this._timeoutID){clearTimeout(this._timeoutID)}if(this.timeout!==Infinity){this._timeoutID=setTimeout(()=>{this._timeoutID=undefined;c=u.next("").value},this.timeout)}};this._endListener=()=>{if(!c){let e=l.end();if(e)for(let t of e){if(u.next(t).value){c=true;break}}}};this._input=e;this.output=s||(e===process.stdin?process.stdout:null);this._encoding=r;this.timeout=a;this._timeoutID=undefined;this._isPaused=true;this.resume()}pause(e=true){if(!this._isPaused){this._input.removeListener("data",this._dataListener);this._input.removeListener("end",this._endListener);if(e&&this._input.pause)this._input.pause();this._isPaused=true;return true}else return false}resume(e=true){if(this._isPaused){this._input.on("data",this._dataListener);this._input.on("end",this._endListener);if(e&&this._input.resume)this._input.resume();this._isPaused=false;return true}else return false}enableMouse(e=0,t=true){this.output.write(`[?1000h`);if(e===1)this.output.write(`[?1001h`);else{if(e>=2)this.output.write(`[?1002h`);if(e===3)this.output.write(`[?1003h`)}if(t)this.output.write(`[?1006h`)}disableMouse(){this.output.write(`[?1000l[?1006l`)}enableBPM(){this.output.write("[?2004h")}disableBPM(){this.output.write("[?2004l")}enableFocus(){this.output.write("[?1004h")}disableFocus(){this.output.write("[?1004l")}}Object.assign(r,{VT200_MOUSE:0,VT200_HIGHLIGHT_MOUSE:1,BTN_EVENT_MOUSE:2,ANY_EVENT_MOUSE:3,KeyboardEvent:s,MouseEvent:i,HighlightEvent:a});module.exports=r;