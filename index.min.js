const EventEmitter=require("events");class KeyboardEvent{constructor({name:e,sequence:t,isSpecial:a=!1,ctrl:s=!1,alt:i=!1,shift:n=!1}){if("string"!=typeof e)throw new TypeError;this.name=e,this.sequence=t,this.isSpecial=a,this.ctrl=s,this.alt=i,this.shift=n}toString(){return(this.ctrl?"Ctrl+":"")+(this.alt?"Alt+":"")+(this.shift?"Shift+":"")+this.name}}class MouseEvent{constructor(e){Object.assign(this,e)}}function*emitKeys(e){function t(t,a,s,i=!1){if(t<0||a<1||s<1||isNaN(t)||isNaN(a)||isNaN(s))return;let n,r,c={x:a,y:s};if(n=3&t,64&t&&(n|=4),128&t&&(n|=8),n+=1,32&t)r="mousemove",c.button=4===n?void 0:n;else switch(n){case 4:r="mouseup",c.button=void 0;break;case 5:r="wheel",c.direction=-1;break;case 6:r="wheel",c.direction=1;break;default:r=i?"mouseup":"mousedown",c.button=n}c.shift=Boolean(4&t),c.alt=Boolean(8&t),c.ctrl=Boolean(16&t),c.type=r,e.emit(r,new MouseEvent(c)),e.emit("mouse",new MouseEvent(c))}let a,s=!1,i=yield;e:for(;;){if(""===i){i=yield;continue}a=i;const n={name:void 0,sequence:void 0,isSpecial:!0,ctrl:!1,alt:!1,shift:!1};let r=0;if(""===i&&(r=1,a+=i=yield,""===i&&(r=2,a+=i=yield),""===i||a.length>1&&""===i))e.emit("keypress",new KeyboardEvent({name:"escape",sequence:a,isSpecial:!0})),""===(i=yield)&&(i=yield);else if(!r||"O"!==i&&"["!==i){if(n.alt=Boolean(r),n.sequence=a,"\r"===i)n.name="enter";else if("\n"===i){if(s){i=yield;continue}n.name="enter"}else if("\t"===i)n.name="tab";else if("\b"===i||""===i)n.name="backspace";else if(" "===i)n.name="space";else if(i<="")n.name=String.fromCharCode(i.charCodeAt(0)+64).toLowerCase(),n.ctrl=!0;else if(""===i)n.name="-",n.ctrl=!0;else{n.isSpecial=!1;const e=i.charCodeAt(0);if(128&e){if(64&e){let t,a,s,r,c;if(32&e)if(16&e){if(8&e)continue;t=4}else t=3;else t=2;switch(t){case 2:if(!(128&(a=(i=yield).charCodeAt(0)))||64&a)continue;n.name=String.fromCharCode((31&e)<<6|63&a);break;case 3:if(!(128&(a=(i=yield).charCodeAt(0)))||64&a)continue;if(!(128&(s=(i=yield).charCodeAt(0)))||64&s)continue;if((c=(15&e)<<12|(63&a)<<6|63&s)>=55296&&c<=57343)continue;n.name=String.fromCharCode(c);break;case 4:if(!(128&(a=(i=yield).charCodeAt(0)))||64&a){e=a;continue}if(!(128&(s=(i=yield).charCodeAt(0)))||64&s){e=s;continue}if(!(128&(r=(i=yield).charCodeAt(0)))||64&r){e=r;continue}if((c=(7&e)<<18|(63&a)<<12|(63&s)<<6|63&r)>=55296&&c<=57343)continue;n.name=String.fromCodePoint(c)}}}else n.name=i;n.sequence="".repeat(r)+n.name}e.emit("keypress",new KeyboardEvent(n)),s="\r"===i,i=yield}else{let s=i,c=0;if("O"===i)a+=i=yield,i>="0"&&i<="9"&&(c=(i>>0)-1,a+=i=yield),s+=i;else if("["===i){const o=a.length;if(a+=i=yield,"M"===i){for(let t=0;t<3;t++){if(""===(i=yield)){e.emit("unknownSequence",a),i=yield;continue e}a+=i}t(a[o+1].charCodeAt(0)-32,a[o+2].charCodeAt(0)-32,a[o+3].charCodeAt(0)-32),i=yield;continue}"["===i&&(s+=i,a+=i=yield);const l=a.length-1;for(;;){const t=i.charCodeAt(0);if(t>=64&&t<=126||36===t)break;if(!(t>=32&&t<=63)){e.emit("unknownSequence",a);continue e}a+=i=yield}const m=a.slice(o);if("<"===m[0]&&("M"===i||"m"===i)||"I"===m[0]||"O"===m[0]||"200~"===m){if(r>=2&&e.emit("keypress",new Key({name:"escape",isSpecial:!0})),"<"!==m[0]||"M"!==i&&"m"!==i){if("I"===m[0])e.emit("focusin");else if("O"===m[0])e.emit("focusout");else if("200~"===m){const t="[201~";let a="",s=0;for(;;)if(a+=i=yield,i===t[s]?s++:s=0,s>=t.length){e.emit("paste",Buffer.from(a.slice(0,a.length-t.length),"binary").toString("utf-8"));break}}}else{const e=a.slice(3,a.length-1).split(";");3===e.length&&t(parseInt(e[0]),parseInt(e[1]),parseInt(e[2]),"m"===i)}i=yield;continue}const f=a.slice(l);let h;switch((h=f.match(/^(\d\d?)(;(\d))?([~^$])$/))?(s+=h[1]+h[4],c=(h[3]||1)-1):(h=f.match(/^((\d;)?(\d))?([A-Za-z])$/))?(s+=h[4],c=(h[3]||1)-1):s+=f,s[s.length-1]){case"$":n.shift=!0,s=s.slice(0,s.length-1)+"~";break;case"^":n.ctrl=!0,s=s.slice(0,s.length-1)+"~";break;case"@":n.shift=n.ctrl=!0,s=s.slice(0,s.length-1)+"~"}}if(n.ctrl=n.ctrl||Boolean(4&c),n.alt=Boolean(10&c),n.shift=n.shift||Boolean(1&c),r>=2&&(n.alt=!0),s.match(/^(O|\[)[A-Z]$/))switch(s[1]){case"A":n.name="up";break;case"B":n.name="down";break;case"C":n.name="right";break;case"D":n.name="left";break;case"E":n.name="clear";break;case"F":n.name="end";break;case"H":n.name="home";break;case"P":n.name="f1";break;case"Q":n.name="f2";break;case"R":n.name="f3";break;case"S":n.name="f4"}else switch(s){case"[11~":n.name="f1";break;case"[12~":n.name="f2";break;case"[13~":n.name="f3";break;case"[14~":n.name="f4";break;case"[[A":n.name="f1";break;case"[[B":n.name="f2";break;case"[[C":n.name="f3";break;case"[[D":n.name="f4";break;case"[[E":case"[15~":n.name="f5";break;case"[17~":n.name="f6";break;case"[18~":n.name="f7";break;case"[19~":n.name="f8";break;case"[20~":n.name="f9";break;case"[21~":n.name="f10";break;case"[23~":n.name="f11";break;case"[24~":n.name="f12";break;case"[25~":n.name="f3",n.shift=!0;break;case"[26~":n.name="f4",n.shift=!0;break;case"[28~":n.name="f5",n.shift=!0;break;case"[29~":n.name="f6",n.shift=!0;break;case"[31~":n.name="f7",n.shift=!0;break;case"[32~":n.name="f8",n.shift=!0;break;case"[33~":n.name="f9",n.shift=!0;break;case"[34~":n.name="f10",n.shift=!0;break;case"[1~":n.name="home";break;case"[2~":n.name="insert";break;case"[3~":n.name="delete";break;case"[4~":n.name="end";break;case"[5~":n.name="pageup";break;case"[6~":n.name="pagedown";break;case"[[5~":n.name="pageup";break;case"[[6~":n.name="pagedown";break;case"[7~":n.name="home";break;case"[8~":n.name="end";break;case"[a":n.name="up",n.shift=!0;break;case"[b":n.name="down",n.shift=!0;break;case"[c":n.name="right",n.shift=!0;break;case"[d":n.name="left",n.shift=!0;break;case"[e":n.name="clear",n.shift=!0;break;case"Oa":n.name="up",n.ctrl=!0;break;case"Ob":n.name="down",n.ctrl=!0;break;case"Oc":n.name="right",n.ctrl=!0;break;case"Od":n.name="left",n.ctrl=!0;break;case"Oe":n.name="clear",n.ctrl=!0;break;case"[Z":n.name="tab",n.shift=!0}n.sequence=a,void 0!==n.name?e.emit("keypress",new KeyboardEvent(n)):e.emit("unknownSequence",a),i=yield}}}class Terminal extends EventEmitter{constructor(e=process.stdin,t,{escKeyTimeout:a=500,timeout:s=a}={}){super();const i=emitKeys(this);i.next(),this._dataListener=e=>{e=e.toString("binary");for(let t=0;t<e.length;t++)i.next(e[t]);this._timeoutID&&clearTimeout(this._timeoutID),this.timeout!==1/0&&(this._timeoutID=setTimeout(()=>{this._timeoutID=void 0,i.next("")},this.timeout))},this._input=e,this.output=t||(e===process.stdin?process.stdout:null),this.timeout=s,this._timeoutID=void 0,this.resume()}pause(){this._input.removeListener("data",this._dataListener)}resume(){this._input.on("data",this._dataListener)}enableMouse(e=0,t=!0){this.output.write("[?1000h"),e>=2&&this.output.write("[?1002h"),3==e&&this.output.write("[?1003h"),t&&this.output.write("[?1006h")}disableMouse(){this.output.write("[?1000l")}enableBPM(){this.output.write("[?2004h")}disableBPM(){this.output.write("[?2004l")}enableFocus(){this.output.write("[?1004h")}disableFocus(){this.output.write("[?1004l")}}Object.assign(Terminal,{VT200_MOUSE:0,BTN_EVENT_MOUSE:2,ANY_EVENT_MOUSE:3,KeyboardEvent:KeyboardEvent,MouseEvent:MouseEvent}),module.exports=Terminal;