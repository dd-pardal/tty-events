const EventEmitter=require("events");class KeyboardEvent{constructor({name:e,sequence:t,isSpecial:a=false,ctrl:i=false,alt:s=false,shift:n=false}){if(typeof e!=="string")throw new TypeError;this.name=e;this.sequence=t;this.isSpecial=a;this.ctrl=i;this.alt=s;this.shift=n}toString(){return(this.ctrl?"Ctrl+":"")+(this.alt?"Alt+":"")+(this.shift?"Shift+":"")+this.name}}class MouseEvent{constructor(e){Object.assign(this,e)}}class HighlightEvent{constructor(e,t,a,i,s,n){this.startX=e;this.startY=t;this.endX=a;this.endY=i;this.mouseX=s;this.mouseY=n}}function*emitKeys(e){function t(t,a,i,s=false){if(t<0||a<1||i<1||isNaN(t)||isNaN(a)||isNaN(i))return;let n,r,c={x:a,y:i};n=t&3;if(t&64||t&128){if(t&64)n|=4;if(t&128)n|=8}else if(n===3)n=undefined;else n+=1;c.button=n;if(t&32){r="mousemove"}else{switch(n){case undefined:r="mouseup";break;case 4:r="wheel";c.direction=-1;break;case 5:r="wheel";c.direction=1;break;default:if(s)r="mouseup";else r="mousedown";break}}c.shift=Boolean(t&4);c.alt=Boolean(t&8);c.ctrl=Boolean(t&16);c.type=r;e.emit(r,new MouseEvent(c));e.emit("mouse",new MouseEvent(c))}function a(t){var a,i,s,n,r,c;if(t.length===6)[a,i,s,n,r,c]=t;else{s=r=t[0];n=c=t[1]}e.emit("highlight",new HighlightEvent(a,i,s,n,r,c))}function i(){e.emit("keypress",new KeyboardEvent({name:"escape",sequence:"",isSpecial:true}))}let s=false,n=yield,r;e:while(true){if(n===""){n=yield;continue}r=n;const c={name:undefined,sequence:undefined,isSpecial:true,ctrl:false,alt:false,shift:false};let l=0;if(n===""){l=1;r+=n=yield;if(n===""){l=2;r+=n=yield}if(n===""||r.length>1&&n===""){e.emit("keypress",new KeyboardEvent({name:"escape",sequence:r,isSpecial:true}));n=yield;if(n===""){n=yield}continue}}if(l&&(n==="O"||n==="[")){let s=n;let o=0;if(n==="O"){r+=n=yield;if(n>="0"&&n<="9"){o=(n>>0)-1;r+=n=yield}else if(n===""){e.emit("keypress",new KeyboardEvent({name:"O",sequence:r,alt:true}));n=yield;continue e}s+=n}else if(n==="["){const u=r.length;r+=n=yield;if(n===""){e.emit("keypress",new KeyboardEvent({name:"[",sequence:r,alt:true}));n=yield;continue e}if(n==="M"){const a=[];for(let t=0;t<3;t++){n=yield;if(n===""){e.emit("unknownSequence",r);n=yield;continue e}r+=n;a.push(n.charCodeAt(0)-32)}t(...a);n=yield;continue}else if(n==="T"||n==="t"){const t=n,i=t==="T"?6:2;const s=[];for(let t=0;t<i;t++){n=yield;if(n===""){e.emit("unknownSequence",r);n=yield;continue e}r+=n;s.push(n.charCodeAt(0)-32)}a(s);n=yield;continue}if(n==="["){s+=n;r+=n=yield}const f=r.length-1;while(true){const t=n.charCodeAt(0);if(t>=64&&t<=126||t===36){break}else if(t>=32&&t<=63){r+=n=yield}else{e.emit("unknownSequence",r);continue e}}const m=r.slice(u);if(m[0]==="<"&&(n==="M"||n==="m")||m[0]==="<"&&(n==="T"||n==="t")||m[0]==="I"||m[0]==="O"||m==="200~"){if(l>=2)i();if(n==="M"||n==="m"||n==="T"||n==="t"){const i=n==="M"||n==="m",s=m.slice(1,m.length-1).split(";");let c=s.length!==(i?3:n==="t"?2:6);if(!c){for(let e=0;e<s.length;e++){const t=parseInt(s[e]);if(isNaN(t)){c=true;break}s[e]=t}}if(c){e.emit("unknownSequence",r)}else{if(i){t(...s,n==="m")}else{a(s)}}}else if(m[0]==="I"){e.emit("focusin")}else if(m[0]==="O"){e.emit("focusout")}else if(m==="200~"){const t="[201~";let a="",i=0;while(true){a+=n=yield;if(n===t[i])i++;else i=0;if(i>=t.length){e.emit("paste",Buffer.from(a.slice(0,a.length-t.length),"binary").toString("utf-8"));break}}}n=yield;continue}const h=r.slice(f);let d;if(d=h.match(/^(\d\d?)(;(\d))?([~^$])$/)){s+=d[1]+d[4];o=(d[3]||1)-1}else if(d=h.match(/^((\d;)?(\d))?([A-Za-z])$/)){s+=d[4];o=(d[3]||1)-1}else{s+=h}switch(s[s.length-1]){case"$":c.shift=true;s=s.slice(0,s.length-1)+"~";break;case"^":c.ctrl=true;s=s.slice(0,s.length-1)+"~";break;case"@":c.shift=c.ctrl=true;s=s.slice(0,s.length-1)+"~";break}}c.ctrl=c.ctrl||Boolean(o&4);c.alt=Boolean(o&10);c.shift=c.shift||Boolean(o&1);if(l>=2){c.alt=true}if(s.match(/^(O|\[)[A-Z]$/)){switch(s[1]){case"A":c.name="up";break;case"B":c.name="down";break;case"C":c.name="right";break;case"D":c.name="left";break;case"E":c.name="clear";break;case"F":c.name="end";break;case"H":c.name="home";break;case"P":c.name="f1";break;case"Q":c.name="f2";break;case"R":c.name="f3";break;case"S":c.name="f4";break}}else{switch(s){case"[11~":c.name="f1";break;case"[12~":c.name="f2";break;case"[13~":c.name="f3";break;case"[14~":c.name="f4";break;case"[[A":c.name="f1";break;case"[[B":c.name="f2";break;case"[[C":c.name="f3";break;case"[[D":c.name="f4";break;case"[[E":c.name="f5";break;case"[15~":c.name="f5";break;case"[17~":c.name="f6";break;case"[18~":c.name="f7";break;case"[19~":c.name="f8";break;case"[20~":c.name="f9";break;case"[21~":c.name="f10";break;case"[23~":c.name="f11";break;case"[24~":c.name="f12";break;case"[25~":c.name="f3";c.shift=true;break;case"[26~":c.name="f4";c.shift=true;break;case"[28~":c.name="f5";c.shift=true;break;case"[29~":c.name="f6";c.shift=true;break;case"[31~":c.name="f7";c.shift=true;break;case"[32~":c.name="f8";c.shift=true;break;case"[33~":c.name="f9";c.shift=true;break;case"[34~":c.name="f10";c.shift=true;break;case"[1~":c.name="home";break;case"[2~":c.name="insert";break;case"[3~":c.name="delete";break;case"[4~":c.name="end";break;case"[5~":c.name="pageup";break;case"[6~":c.name="pagedown";break;case"[[5~":c.name="pageup";break;case"[[6~":c.name="pagedown";break;case"[7~":c.name="home";break;case"[8~":c.name="end";break;case"[a":c.name="up";c.shift=true;break;case"[b":c.name="down";c.shift=true;break;case"[c":c.name="right";c.shift=true;break;case"[d":c.name="left";c.shift=true;break;case"[e":c.name="clear";c.shift=true;break;case"Oa":c.name="up";c.ctrl=true;break;case"Ob":c.name="down";c.ctrl=true;break;case"Oc":c.name="right";c.ctrl=true;break;case"Od":c.name="left";c.ctrl=true;break;case"Oe":c.name="clear";c.ctrl=true;break;case"[Z":c.name="tab";c.shift=true;break}}c.sequence=r;if(c.name!==undefined){e.emit("keypress",new KeyboardEvent(c))}else{e.emit("unknownSequence",r)}n=yield;continue}else{if(l>=2)i();c.alt=Boolean(l);c.sequence=r;if(n==="\r"){c.name="enter"}else if(n==="\n"){if(s){n=yield;continue}c.name="enter"}else if(n==="\t"){c.name="tab"}else if(n==="\b"||n===""){c.name="backspace"}else if(n===" "){c.name="space"}else if(n<=""){c.name=String.fromCharCode(n.charCodeAt(0)+64).toLowerCase();c.ctrl=true}else if(n===""){c.name="-";c.ctrl=true}else{c.isSpecial=false;const e=n.charCodeAt(0);if(!(e&128)){c.name=n}else if(e&64){let t;if(e&32){if(e&16){if(e&8){n=yield;continue}else{t=4}}else{t=3}}else{t=2}let a,i,s,r;switch(t){case 2:a=(n=yield).charCodeAt(0);if(!(a&128)||a&64){continue}c.name=String.fromCharCode((e&31)<<6|a&63);break;case 3:a=(n=yield).charCodeAt(0);if(!(a&128)||a&64){continue}i=(n=yield).charCodeAt(0);if(!(i&128)||i&64){continue}r=(e&15)<<12|(a&63)<<6|i&63;if(r>=55296&&r<=57343){continue}c.name=String.fromCharCode(r);break;case 4:a=(n=yield).charCodeAt(0);if(!(a&128)||a&64){e=a;continue}i=(n=yield).charCodeAt(0);if(!(i&128)||i&64){e=i;continue}s=(n=yield).charCodeAt(0);if(!(s&128)||s&64){e=s;continue}r=(e&7)<<18|(a&63)<<12|(i&63)<<6|s&63;if(r>=55296&&r<=57343){continue}c.name=String.fromCodePoint(r);break}}c.sequence=(l?"":"")+c.name}}e.emit("keypress",new KeyboardEvent(c));s=n==="\r";n=yield}}class Terminal extends EventEmitter{constructor(e=process.stdin,t,{escKeyTimeout:a=500,timeout:i=a}={}){super();const s=emitKeys(this);s.next();this._dataListener=e=>{e=e.toString("binary");for(let t=0;t<e.length;t++){s.next(e[t])}if(this._timeoutID){clearTimeout(this._timeoutID)}if(this.timeout!==Infinity){this._timeoutID=setTimeout(()=>{this._timeoutID=undefined;s.next("")},this.timeout)}};this._input=e;this.output=t||(e===process.stdin?process.stdout:null);this.timeout=i;this._timeoutID=undefined;this.resume()}pause(){this._input.removeListener("data",this._dataListener)}resume(){this._input.on("data",this._dataListener)}enableMouse(e=0,t=true){this.output.write(`[?1000h`);if(e===1)this.output.write(`[?1001h`);else{if(e>=2)this.output.write(`[?1002h`);if(e===3)this.output.write(`[?1003h`)}if(t)this.output.write(`[?1006h`)}disableMouse(){this.output.write(`[?1000l[?1006l`)}enableBPM(){this.output.write("[?2004h")}disableBPM(){this.output.write("[?2004l")}enableFocus(){this.output.write("[?1004h")}disableFocus(){this.output.write("[?1004l")}}Object.assign(Terminal,{VT200_MOUSE:0,VT200_HIGHLIGHT_MOUSE:1,BTN_EVENT_MOUSE:2,ANY_EVENT_MOUSE:3,KeyboardEvent:KeyboardEvent,MouseEvent:MouseEvent,HighlightEvent:HighlightEvent});module.exports=Terminal;